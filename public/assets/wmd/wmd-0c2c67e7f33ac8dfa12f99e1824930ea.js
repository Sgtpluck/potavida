function setup_wmd(e){return new WMDEditor(e)}!function(){function e(){var e={};return e.isIE=/msie/.test(d.userAgent.toLowerCase()),e.isIE_5or6=/msie 6/.test(d.userAgent.toLowerCase())||/msie 5/.test(d.userAgent.toLowerCase()),e.isIE_7plus=e.isIE&&!e.isIE_5or6,e.isOpera=/opera/.test(d.userAgent.toLowerCase()),e.isKonqueror=/konqueror/.test(d.userAgent.toLowerCase()),e}WMDEditor=function(e){this.options=WMDEditor.util.extend({},WMDEditor.defaults,e||{}),u(this,this.options),this.startEditor()},window.WMDEditor=WMDEditor,WMDEditor.defaults={version:2.1,output_format:"markdown",lineLength:40,button_bar:"wmd-button-bar",preview:"wmd-preview",output:"wmd-output",input:"wmd-input",imageDialogText:"<p style='margin-top: 0px'><b>Enter the image URL.</b></p><p>You can also add a title, which will be displayed as a tool tip.</p><p>Example:<br />http://i.imgur.com/1cZl4.jpg</p>",linkDialogText:"<p style='margin-top: 0px'><b>Enter the web address.</b></p><p>You can also add a title, which will be displayed as a tool tip.</p><p>Example:<br />http://www.google.com/</p>",imageDefaultText:"http://",linkDefaultText:"http://",imageDirectory:"images/",helpLink:"/wmd/markdownhelp.html",helpHoverTitle:"Markdown Syntax",helpTarget:"_blank",previewPollInterval:500,pastePollInterval:100,buttons:"bold italic  link blockquote code image  ol ul heading hr  undo redo help",autoFormatting:{list:!0,quote:!0,code:!0},modifierKeys:{bold:"b",italic:"i",link:"l",quote:"q",code:"k",image:"g",orderedList:"o",unorderedList:"u",heading:"h",horizontalRule:"r",redo:"y",undo:"z"},tagFilter:{enabled:!1,allowedTags:/^(<\/?(b|blockquote|code|del|dd|dl|dt|em|h1|h2|h3|i|kbd|li|ol|p|pre|s|sup|sub|strong|strike|ul)>|<(br|hr)\s?\/?>)$/i,patternLink:/^(<a\shref=("|')(\#\d+|(https?:\/\/|ftp:\/\/|mailto:)[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+)\2(\stitle="[^"<>]+")?\s?>|<\/a>)$/i,patternImage:/^(<img\ssrc="https?:(\/\/[-A-Za-z0-9+&@#\/%?=~_|!:,.;\(\)]+)"(\swidth="\d{1,3}")?(\sheight="\d{1,3}")?(\salt="[^"<>]*")?(\stitle="[^"<>]*")?\s?\/?>)$/i}},WMDEditor.prototype={getPanels:function(){return{buttonBar:"string"==typeof this.options.button_bar?document.getElementById(this.options.button_bar):this.options.button_bar,preview:"string"==typeof this.options.preview?document.getElementById(this.options.preview):this.options.preview,output:"string"==typeof this.options.output?document.getElementById(this.options.output):this.options.output,input:"string"==typeof this.options.input?document.getElementById(this.options.input):this.options.input}},startEditor:function(){this.panels=this.getPanels(),this.previewMgr=new a(this),edit=new this.editor(this.previewMgr.refresh),this.previewMgr.refresh(!0)}};var t={isVisible:function(e){return e.offsetWidth>0||e.offsetHeight>0},addEvent:function(e,t,n){e.attachEvent?e.attachEvent("on"+t,n):e.addEventListener(t,n,!1)},removeEvent:function(e,t,n){e.detachEvent?e.detachEvent("on"+t,n):e.removeEventListener(t,n,!1)},fixEolChars:function(e){return e=e.replace(/\r\n/g,"\n"),e=e.replace(/\r/g,"\n")},extendRegExp:function(e,t,n){(null===t||void 0===t)&&(t=""),(null===n||void 0===n)&&(n="");var o=e.toString(),i="",r=o.match(/\/([gim]*)$/);return i=null===r?r[0]:"",o=o.replace(/(^\/|\/[gim]*$)/g,""),o=t+o+n,new RegExp(o,i)},createImage:function(e){var t=imageDirectory+e,n=document.createElement("img");return n.className="wmd-button",n.src=t,n},prompt:function(e,o,i,r){var a,s,l,u,p;void 0===o&&(o="");var f=function(e){var t=e.charCode||e.keyCode;27===t&&m(!0)},m=function(e){t.removeEvent(document.body,"keydown",f);var n=l.value+(u.value?' "'+u.value+'"':"");return e?n=null:(n=n.replace("http://http://","http://"),n=n.replace("http://https://","https://"),n=n.replace("http://ftp://","ftp://"),"link"==r&&p.checked&&(n="!"+n)),a.parentNode.removeChild(a),s.parentNode.removeChild(s),i(n),!1},h=function(){s=document.createElement("div"),s.className="wmd-prompt-background",style=s.style,style.position="absolute",style.top="0",style.zIndex="10000",c.isKonqueror?style.backgroundColor="transparent":c.isIE?style.filter="alpha(opacity=50)":style.opacity="0.5";var e=n.getPageSize();style.height=e[1]+"px",c.isIE?(style.left=document.documentElement.scrollLeft,style.width=document.documentElement.clientWidth):(style.left="0",style.width="100%"),document.body.appendChild(s)},g=function(){a=document.createElement("div"),a.className="wmd-prompt-dialog",a.style.padding="10px;",a.style.position="fixed",a.style.width="400px",a.style.zIndex="10001";var i=document.createElement("div");i.innerHTML=e,i.style.padding="5px",a.appendChild(i);var s=document.createElement("form");s.onsubmit=function(){return m(!1)};var h=s.style;h.padding="0",h.margin="0",h.cssFloat="left",h.width="100%",h.textAlign="center",h.position="relative",a.appendChild(s);var g=document.createElement("label");h=g.style,h.display="block",h.width="80%",h.marginLeft=h.marginRight="auto",h.textAlign="left",s.appendChild(g),g.appendChild(document.createTextNode(r+" URL:")),l=document.createElement("input"),l.type="text",l.value=o,h=l.style,h.display="block",h.width="100%",h.marginLeft=h.marginRight="auto",g.appendChild(l),g=document.createElement("label"),h=g.style,h.display="block",h.width="80%",h.marginLeft=h.marginRight="auto",h.textAlign="left",s.appendChild(g),g.appendChild(document.createTextNode(r+" Title (Hover Text):")),u=document.createElement("input"),u.type="text",h=u.style,h.display="block",h.width="100%",h.marginLeft=h.marginRight="auto",g.appendChild(u),"link"==r&&(g=document.createElement("label"),h=g.style,h.display="block",h.textAlign="center",s.appendChild(g),p=document.createElement("input"),p.type="checkbox",p.value="!",g.appendChild(p),g.appendChild(document.createTextNode(" Have this link open in a new window")));var b=document.createElement("input");b.type="button",b.onclick=function(){return m(!1)},b.value="OK",h=b.style,h.margin="10px",h.display="inline",h.width="7em";var v=document.createElement("input");v.type="button",v.onclick=function(){return m(!0)},v.value="Cancel",h=v.style,h.margin="10px",h.display="inline",h.width="7em",/mac/.test(d.platform.toLowerCase())?(s.appendChild(v),s.appendChild(b)):(s.appendChild(b),s.appendChild(v)),t.addEvent(document.body,"keydown",f),a.style.top="50%",a.style.left="50%",a.style.display="block",c.isIE_5or6&&(a.style.position="absolute",a.style.top=document.documentElement.scrollTop+200+"px",a.style.left="50%"),document.body.appendChild(a),a.style.marginTop=-(n.getHeight(a)/2)+"px",a.style.marginLeft=-(n.getWidth(a)/2)+"px"};h(),window.setTimeout(function(){g();var e=o.length;if(void 0!==l.selectionStart)l.selectionStart=0,l.selectionEnd=e;else if(l.createTextRange){var t=l.createTextRange();t.collapse(!1),t.moveStart("character",-e),t.moveEnd("character",e),t.select()}l.focus()},0)},extend:function(){function e(t,n){for(var o in n)n.hasOwnProperty(o)&&("object"==typeof t[o]&&"object"==typeof n[o]?e(t[o],n[o]):t[o]=n[o]);return t}for(var t={},n=0;n<arguments.length;n++)e(t,arguments[n]);return t}},n={getTop:function(e,t){var n=e.offsetTop;if(!t)for(;e=e.offsetParent;)n+=e.offsetTop;return n},getHeight:function(e){return e.offsetHeight||e.scrollHeight},getWidth:function(e){return e.offsetWidth||e.scrollWidth},getPageSize:function(){var e,t,n,o;self.innerHeight&&self.scrollMaxY?(e=document.body.scrollWidth,t=self.innerHeight+self.scrollMaxY):document.body.scrollHeight>document.body.offsetHeight?(e=document.body.scrollWidth,t=document.body.scrollHeight):(e=document.body.offsetWidth,t=document.body.offsetHeight),self.innerHeight?(n=self.innerWidth,o=self.innerHeight):document.documentElement&&document.documentElement.clientHeight?(n=document.documentElement.clientWidth,o=document.documentElement.clientHeight):document.body&&(n=document.body.clientWidth,o=document.body.clientHeight);var i=Math.max(e,n),r=Math.max(t,o);return[i,r,n,o]}},o=function(e,n){var o=this,r=e;this.init=function(){t.isVisible(r)&&(this.setInputAreaSelectionStartEnd(),this.scrollTop=r.scrollTop,(!this.text&&r.selectionStart||0===r.selectionStart)&&(this.text=r.value))},this.setInputAreaSelection=function(){if(t.isVisible(r))if(void 0===r.selectionStart||c.isOpera){if(document.selection){if("unknown"!=typeof document.activeElement&&document.activeElement&&document.activeElement!==r)return;r.focus();var e=r.createTextRange();e.moveStart("character",-r.value.length),e.moveEnd("character",-r.value.length),e.moveEnd("character",o.end),e.moveStart("character",o.start),e.select()}}else r.focus(),r.selectionStart=o.start,r.selectionEnd=o.end,r.scrollTop=o.scrollTop},this.setInputAreaSelectionStartEnd=function(){if(r.selectionStart||0===r.selectionStart)o.start=r.selectionStart,o.end=r.selectionEnd;else if(document.selection){o.text=t.fixEolChars(r.value);var e;n.ieRetardedClick&&n.ieCachedRange?(e=n.ieCachedRange,n.ieRetardedClick=!1):e=document.selection.createRange();var i=t.fixEolChars(e.text),a="",s=a+i+a;e.text=s;var l=t.fixEolChars(r.value);e.moveStart("character",-s.length),e.text=i,o.start=l.indexOf(a),o.end=l.lastIndexOf(a)-a.length;var d=o.text.length-t.fixEolChars(r.value).length;if(d){for(e.moveStart("character",-i.length);d--;)i+="\n",o.end+=1;e.text=i}this.setInputAreaSelection()}},this.restore=function(){void 0!=o.text&&o.text!=r.value&&(r.value=o.text),this.setInputAreaSelection(),r.scrollTop=o.scrollTop},this.getChunks=function(){var e=new i;return e.before=t.fixEolChars(o.text.substring(0,o.start)),e.startTag="",e.selection=t.fixEolChars(o.text.substring(o.start,o.end)),e.endTag="",e.after=t.fixEolChars(o.text.substring(o.end)),e.scrollTop=o.scrollTop,e},this.setChunks=function(e){e.before=e.before+e.startTag,e.after=e.endTag+e.after,c.isOpera&&(e.before=e.before.replace(/\n/g,"\r\n"),e.selection=e.selection.replace(/\n/g,"\r\n"),e.after=e.after.replace(/\n/g,"\r\n")),this.start=e.before.length,this.end=e.before.length+e.selection.length,this.text=e.before+e.selection+e.after,this.scrollTop=e.scrollTop},this.init()},i=function(){};i.prototype.findTags=function(e,n){var o,i=this;e&&(o=t.extendRegExp(e,"","$"),this.before=this.before.replace(o,function(e){return i.startTag=i.startTag+e,""}),o=t.extendRegExp(e,"^",""),this.selection=this.selection.replace(o,function(e){return i.startTag=i.startTag+e,""})),n&&(o=t.extendRegExp(n,"","$"),this.selection=this.selection.replace(o,function(e){return i.endTag=e+i.endTag,""}),o=t.extendRegExp(n,"^",""),this.after=this.after.replace(o,function(e){return i.endTag=e+i.endTag,""}))},i.prototype.trimWhitespace=function(e){this.selection=this.selection.replace(/^(\s*)/,""),e||(this.before+=l.$1),this.selection=this.selection.replace(/(\s*)$/,""),e||(this.after=l.$1+this.after)},i.prototype.addBlankLines=function(e,t,n){void 0===e&&(e=1),void 0===t&&(t=1),e++,t++;var o,i,r=/(^\n*)/.exec(this.selection);if(this.selection=this.selection.replace(/(^\n*)/,""),this.startTag=this.startTag+(r?r[1]:""),r=/(\n*$)/.exec(this.selection),this.selection=this.selection.replace(/(\n*$)/,""),this.endTag=this.endTag+(r?r[1]:""),r=/(^\n*)/.exec(this.startTag),this.startTag=this.startTag.replace(/(^\n*)/,""),this.before=this.before+(r?r[1]:""),r=/(\n*$)/.exec(this.endTag),this.endTag=this.endTag.replace(/(\n*$)/,""),this.after=this.after+(r?r[1]:""),this.before){for(o=i="";e--;)o+="\\n?",i+="\n";n&&(o="\\n*"),this.before=this.before.replace(new l(o+"$",""),i)}if(this.after){for(o=i="";t--;)o+="\\n?",i+="\n";n&&(o="\\n*"),this.after=this.after.replace(new l(o,""),i)}};var r=function(e,n,o){var i,r,a,s,l=this,d=e;this.tick=function(){if(t.isVisible(d)){if(d.selectionStart||0===d.selectionStart){var e=d.selectionStart,n=d.selectionEnd;if((e!=i||n!=r)&&(i=e,r=n,a!=d.value))return a=d.value,!0}return!1}};var c=function(){t.isVisible(d)&&l.tick()&&n()},u=function(){s=window.setInterval(c,o)};this.destroy=function(){window.clearInterval(s)},u()},a=function(e){var o,i,a,s,l,d,u=this,p=3e3,f="delayed",m=function(n,o){t.addEvent(n,"input",o),n.onpaste=o,n.ondrop=o,t.addEvent(n,"keypress",o),t.addEvent(n,"keydown",o),i=new r(e.panels.input,o,e.options.previewPollInterval)},h=function(){var e=0;return window.innerHeight?e=window.pageYOffset:document.documentElement&&document.documentElement.scrollTop?e=document.documentElement.scrollTop:document.body&&(e=document.body.scrollTop),e},g=function(){if(e.panels.preview||e.panels.output){var t=e.panels.input.value;if(!t||t!=l){l=t;var n=(new Date).getTime();!o&&e.showdown&&(o=new e.showdown.converter),o&&(t=o.makeHtml(t));var i=(new Date).getTime();s=i-n,T(t),d=t}}},b=function(){if(a&&(window.clearTimeout(a),a=void 0),"manual"!==f){var e=0;"delayed"===f&&(e=s),e>p&&(e=p),a=window.setTimeout(g,e)}},v=function(e){return e.scrollHeight<=e.clientHeight?1:e.scrollTop/(e.scrollHeight-e.clientHeight)},w=function(){e.panels.preview&&(e.panels.preview.scrollTop=(e.panels.preview.scrollHeight-e.panels.preview.clientHeight)*v(e.panels.preview)),e.panels.output&&(e.panels.output.scrollTop=(e.panels.output.scrollHeight-e.panels.output.clientHeight)*v(e.panels.output))};this.refresh=function(e){e?(l="",g()):b()},this.processingTime=function(){return s},this.output=function(){return d},this.setUpdateMode=function(e){f=e,u.refresh()};var y=!0,T=function(t){var o=n.getTop(e.panels.input)-h();if(e.panels.output)if(void 0!==e.panels.output.value)e.panels.output.value=t;else{var i=t.replace(/&/g,"&amp;");i=i.replace(/</g,"&lt;"),e.panels.output.innerHTML="<pre><code>"+i+"</code></pre>"}if(e.panels.preview&&(e.options.tagFilter.enabled&&(t=t.replace(/<[^<>]*>?/gi,function(t){return t.match(e.options.tagFilter.allowedTags)||t.match(e.options.tagFilter.patternLink)||t.match(e.options.tagFilter.patternImage)?t:""})),e.panels.preview.innerHTML=t),w(),y)return void(y=!1);var r=n.getTop(e.panels.input)-h();c.isIE?window.setTimeout(function(){window.scrollBy(0,r-o)},0):window.scrollBy(0,r-o)},k=function(){m(e.panels.input,b),g(),e.panels.preview&&(e.panels.preview.scrollTop=0),e.panels.output&&(e.panels.output.scrollTop=0)};this.destroy=function(){i&&i.destroy()},k()},s=function(e,n,i,a){var s,l,d,u,p=this,f=[],m=0,h="none",g=function(e,t){h!=e&&(h=e,t||v()),c.isIE&&"moving"==h?u=null:d=window.setTimeout(b,1)},b=function(){u=new o(n,e),l.tick(),d=void 0};this.setCommandMode=function(){h="command",v(),d=window.setTimeout(b,0)},this.canUndo=function(){return m>1},this.canRedo=function(){return f[m+1]?!0:!1},this.undo=function(){p.canUndo()&&(s?(s.restore(),s=null):(f[m]=new o(n,e),f[--m].restore(),a&&a())),h="none",n.focus(),b()},this.redo=function(){p.canRedo()&&(f[++m].restore(),a&&a()),h="none",n.focus(),b()};var v=function(){var t=u||new o(n,e);return t?"moving"==h?void(s||(s=t)):(s&&(f[m-1].text!=s.text&&(f[m++]=s),s=null),f[m++]=t,f[m+1]=null,void(a&&a())):!1},w=function(e){var t=!1;if(e.ctrlKey||e.metaKey){var n=e.charCode||e.keyCode,o=String.fromCharCode(n);switch(o){case"y":p.redo(),t=!0;break;case"z":e.shiftKey?p.redo():p.undo(),t=!0}}return t?(e.preventDefault&&e.preventDefault(),void(window.event&&(window.event.returnValue=!1))):void 0},y=function(e){if(!e.ctrlKey&&!e.metaKey){var t=e.keyCode;t>=33&&40>=t||t>=63232&&63235>=t?g("moving"):8==t||46==t||127==t?g("deleting"):13==t?g("newlines"):27==t?g("escape"):(16>t||t>20)&&91!=t&&g("typing")}},T=function(){t.addEvent(n,"keypress",function(e){!e.ctrlKey&&!e.metaKey||89!=e.keyCode&&90!=e.keyCode||e.preventDefault()});var e=function(){(c.isIE||u&&u.text!=n.value)&&void 0==d&&(h="paste",v(),b())};l=new r(n,e,i),t.addEvent(n,"keydown",w),t.addEvent(n,"keydown",y),t.addEvent(n,"mousedown",function(){g("moving")}),n.onpaste=e,n.ondrop=e},k=function(){T(),b(),v()};this.destroy=function(){l&&l.destroy()},k()};WMDEditor.util=t,WMDEditor.position=n,WMDEditor.TextareaState=o,WMDEditor.InputPoller=r,WMDEditor.PreviewManager=a,WMDEditor.UndoManager=s;var l=(window.document,window.RegExp),d=window.navigator,c=e(),u=function(e,t){e.Command={},e.Global={},e.buttons={},e.showdown=window.Showdown;var n=WMDEditor.util,i=(WMDEditor.position,e.Command);e.ieCachedRange=null,e.ieRetardedClick=!1,e.editor=function(r){r||(r=function(){});var a,l,u,p=e.panels.input,f=this,m=function(t){if(p.focus(),t.textOp){u&&u.setCommandMode();var n=new o(e.panels.input,e);if(!n)return;var i=n.getChunks(),a=function(){p.focus(),i&&n.setChunks(i),n.restore(),r()},s=!0,l=t.textOp(i,a,s);l||a()}t.execute&&t.execute(f)},h=function(){u&&(e.buttons["wmd-undo-button"]&&g(e.buttons["wmd-undo-button"],u.canUndo()),e.buttons["wmd-redo-button"]&&g(e.buttons["wmd-redo-button"],u.canRedo()))},g=function(t,n){n?(t.className=t.className.replace(new RegExp("(^|\\s+)disabled(\\s+|$)")," "),c.isIE&&(t.onmousedown=function(){e.ieRetardedClick=!0,e.ieCachedRange=document.selection.createRange()}),t.isHelp||(t.onclick=function(){return this.onmouseout&&this.onmouseout(),m(this),!1})):(t.className+=(t.className?" ":"")+"disabled",t.onmouseover=t.onmouseout=t.onclick=function(){})},b=function(){function n(t,n,o){var i=document.createElement("li");return e.buttons[t]=i,i.className="wmd-button "+t,i.XShift=l+"px",l-=20,n&&(i.title=n),o&&(i.textOp=o),i}function o(e,t,o){var i=n(e,t,o);return g(i,!0),s.appendChild(i),i}function r(){var e=document.createElement("li");return e.className="wmd-spacer",s.appendChild(e),e}var a="string"==typeof t.button_bar?document.getElementById(t.button_bar||"wmd-button-bar"):t.button_bar,s=document.createElement("ul");s.className="wmd-button-row",s=a.appendChild(s);for(var l=0,c=t.buttons.split(" "),u=0;u<c.length;u++)switch(c[u]){case"bold":o("wmd-bold-button","Strong <strong> Ctrl+B",i.doBold);break;case"italic":o("wmd-italic-button","Emphasis <em> Ctrl+I",i.doItalic);break;case"link":o("wmd-link-button","Hyperlink <a> Ctrl+L",function(e,t){return i.doLinkOrImage(e,t,!1)});break;case"blockquote":o("wmd-quote-button","Blockquote <blockquote> Ctrl+Q",i.doBlockquote);break;case"code":o("wmd-code-button","Code Sample <pre><code> Ctrl+K",i.doCode);break;case"image":o("wmd-image-button","Image <img> Ctrl+G",function(e,t){return i.doLinkOrImage(e,t,!0)});break;case"ol":o("wmd-olist-button","Numbered List <ol> Ctrl+O",function(e,t,n){i.doList(e,t,!0,n)});break;case"ul":o("wmd-ulist-button","Bulleted List <ul> Ctrl+U",function(e,t,n){i.doList(e,t,!1,n)});break;case"heading":o("wmd-heading-button","Heading <h1>/<h2> Ctrl+H",i.doHeading);break;case"hr":o("wmd-hr-button","Horizontal Rule <hr> Ctrl+R",i.doHorizontalRule);break;case"undo":var p=o("wmd-undo-button","Undo - Ctrl+Z");p.execute=function(e){e.undo()};break;case"redo":var f=o("wmd-redo-button","Redo - Ctrl+Y");f.title=/win/.test(d.platform.toLowerCase())?"Redo - Ctrl+Y":"Redo - Ctrl+Shift+Z",f.execute=function(e){e.redo()};break;case"help":var m=n("wmd-help-button");m.isHelp=!0,g(m,!0),s.appendChild(m);var b=document.createElement("a");b.href=t.helpLink,b.target=t.helpTarget,b.title=t.helpHoverTitle,m.appendChild(b);break;case"":r()}h()},v=function(){/\?noundo/.test(document.location.href)&&(e.nativeUndo=!0),e.nativeUndo||(u=new s(e,e.panels.input,e.options.pastePollInterval,function(){r(),h()})),b();var t="keydown";c.isOpera&&(t="keypress"),n.addEvent(p,t,function(t){if(e.options.modifierKeys&&(t.ctrlKey||t.metaKey)){var n=t.charCode||t.keyCode,o=String.fromCharCode(n).toLowerCase();switch(o){case e.options.modifierKeys.bold:if(!e.buttons["wmd-bold-button"])return;m(e.buttons["wmd-bold-button"]);break;case e.options.modifierKeys.italic:if(!e.buttons["wmd-italic-button"])return;m(e.buttons["wmd-italic-button"]);break;case e.options.modifierKeys.link:if(!e.buttons["wmd-link-button"])return;m(e.buttons["wmd-link-button"]);break;case e.options.modifierKeys.quote:if(!e.buttons["wmd-quote-button"])return;m(e.buttons["wmd-quote-button"]);break;case e.options.modifierKeys.code:if(!e.buttons["wmd-code-button"])return;m(e.buttons["wmd-code-button"]);break;case e.options.modifierKeys.image:if(!e.buttons["wmd-image-button"])return;m(e.buttons["wmd-image-button"]);break;case e.options.modifierKeys.orderedList:if(!e.buttons["wmd-olist-button"])return;m(e.buttons["wmd-olist-button"]);break;case e.options.modifierKeys.unorderedList:if(!e.buttons["wmd-ulist-button"])return;m(e.buttons["wmd-ulist-button"]);break;case e.options.modifierKeys.heading:if(!e.buttons["wmd-heading-button"])return;m(e.buttons["wmd-heading-button"]);break;case e.options.modifierKeys.horizontalRule:if(!e.buttons["wmd-hr-button"])return;m(e.buttons["wmd-hr-button"]);break;case e.options.modifierKeys.redo:if(!e.buttons["wmd-redo-button"])return;m(e.buttons["wmd-redo-button"]);break;case e.options.modifierKeys.undo:if(t.shiftKey){if(!e.buttons["wmd-redo-button"])return;m(e.buttons["wmd-redo-button"])}else{if(!e.buttons["wmd-undo-button"])return;m(e.buttons["wmd-undo-button"])}break;default:return}t.preventDefault&&t.preventDefault(),window.event&&(window.event.returnValue=!1)}}),n.addEvent(p,"keyup",function(e){if(!e.shiftKey&&!e.ctrlKey&&!e.metaKey){var t=e.charCode||e.keyCode;13===t&&(fakeButton={},fakeButton.textOp=i.doAutoindent,m(fakeButton))}}),c.isIE&&n.addEvent(p,"keydown",function(e){var t=e.keyCode;return 27===t?!1:void 0})};this.undo=function(){u&&u.undo()},this.redo=function(){u&&u.redo()};var w=function(){v()};this.destroy=function(){u&&u.destroy(),a.parentNode&&a.parentNode.removeChild(a),p&&(p.style.marginTop=""),window.clearInterval(l)},w()},i.prefixes="(?:\\s{4,}|\\s*>|\\s*-\\s+|\\s*\\d+\\.|=|\\+|-|_|\\*|#|\\s*\\[[^\n]]+\\]:)",i.unwrap=function(e){var t=new l("([^\\n])\\n(?!(\\n|"+i.prefixes+"))","g");e.selection=e.selection.replace(t,"$1 $2")},i.wrap=function(e,t){i.unwrap(e);var n=new l("(.{1,"+t+"})( +|$\\n?)","gm");e.selection=e.selection.replace(n,function(e,t){return new l("^"+i.prefixes,"").test(e)?e:t+"\n"}),e.selection=e.selection.replace(/\s+$/,"")},i.doBold=function(e){return i.doBorI(e,2,"strong text")},i.doItalic=function(e){return i.doBorI(e,1,"emphasized text")},i.doBorI=function(e,t,n){e.trimWhitespace(),e.selection=e.selection.replace(/\n{2,}/g,"\n"),e.before.search(/(\**$)/);var o=l.$1;e.after.search(/(^\**)/);var i=l.$1,r=Math.min(o.length,i.length);if(r>=t&&(2!=r||1!=t))e.before=e.before.replace(l("[*]{"+t+"}$",""),""),e.after=e.after.replace(l("^[*]{"+t+"}",""),"");else if(!e.selection&&i){e.after=e.after.replace(/^([*_]*)/,""),e.before=e.before.replace(/(\s?)$/,"");var a=l.$1;e.before=e.before+i+a}else{e.selection||i||(e.selection=n);var s=1>=t?"*":"**";e.before=e.before+s,e.after=s+e.after}},i.stripLinkDefs=function(e,t){return e=e.replace(/^[ ]{0,3}\[(\d+)\]:[ \t]*\n?[ \t]*<?(\S+?)>?[ \t]*\n?[ \t]*(?:(\n*)["(](.+?)[")][ \t]*)?(?:\n+|$)/gm,function(e,n,o,i,r){return t[n]=e.replace(/\s*$/,""),i?(t[n]=e.replace(/["(](.+?)[")]$/,""),i+r):""})},i.addLinkDef=function(e,t){var n=0,o={};e.before=i.stripLinkDefs(e.before,o),e.selection=i.stripLinkDefs(e.selection,o),e.after=i.stripLinkDefs(e.after,o);var r="",a=/(\[(?:\[[^\]]*\]|[^\[\]])*\][ ]?(?:\n[ ]*)?\[)(\d+)(\])/g,s=function(e){n++,e=e.replace(/^[ ]{0,3}\[(\d+)\]:/,"  ["+n+"]:"),r+="\n"+e},l=function(e,t,i,r){return o[i]?(s(o[i]),t+n+r):e};e.before=e.before.replace(a,l),t?s(t):e.selection=e.selection.replace(a,l);var d=n;return e.after=e.after.replace(a,l),e.after&&(e.after=e.after.replace(/\n*$/,"")),e.after||(e.selection=e.selection.replace(/\n*$/,"")),e.after+="\n\n"+r,d},i.doLinkOrImage=function(e,o,r){if(e.trimWhitespace(),e.findTags(/\s*!?\[/,/\][ ]?(?:\n[ ]*)?(\[.*?\])?/),!(e.endTag.length>1)){if(/\n\n/.test(e.selection))return void i.addLinkDef(e,null);var a=function(t){if(console.log(t),null!==t){e.startTag=e.endTag="";var n=" [999]: "+t,a=i.addLinkDef(e,n);e.startTag=r?"![":"[",e.endTag="]["+a+"]",e.selection||(e.selection=r?"alt text":"link text")}o()};return r?n.prompt(t.imageDialogText,t.imageDefaultText,a,"Image"):n.prompt(t.linkDialogText,t.linkDefaultText,a,"Link"),!0}e.startTag=e.startTag.replace(/!?\[/,""),e.endTag="",i.addLinkDef(e,null)},i.doAutoindent=function(t,n,o){e.options.autoFormatting&&(e.options.autoFormatting.list&&(t.before=t.before.replace(/(\n|^)[ ]{0,3}([*+-]|\d+[.])[ \t]*\n$/,"\n\n")),e.options.autoFormatting.quote&&(t.before=t.before.replace(/(\n|^)[ ]{0,3}>[ \t]*\n$/,"\n\n")),e.options.autoFormatting.code&&(t.before=t.before.replace(/(\n|^)[ \t]+\n$/,"\n\n")),o=!1,/(\n|^)[ ]{0,3}([*+-])[ \t]+.*\n$/.test(t.before)&&i.doList&&e.options.autoFormatting.list&&i.doList(t,n,!1,!0),/(\n|^)[ ]{0,3}(\d+[.])[ \t]+.*\n$/.test(t.before)&&i.doList&&e.options.autoFormatting.list&&i.doList(t,n,!0,!0),/(\n|^)[ ]{0,3}>[ \t]+.*\n$/.test(t.before)&&i.doBlockquote&&e.options.autoFormatting.quote&&i.doBlockquote(t,n,o),/(\n|^)(\t|[ ]{4,}).*\n$/.test(t.before)&&i.doCode&&e.options.autoFormatting.code&&i.doCode(t,n,o))},i.doBlockquote=function(e,n,o){e.selection=e.selection.replace(/^(\n*)([^\r]+?)(\n*)$/,function(t,n,o,i){return e.before+=n,e.after=i+e.after,o}),e.before=e.before.replace(/(>[ \t]*)$/,function(t,n){return e.selection=n+e.selection,""});var r=o?"Blockquote":"";e.selection=e.selection.replace(/^(\s|>)+$/,""),e.selection=e.selection||r,e.before&&(e.before=e.before.replace(/\n?$/,"\n")),e.after&&(e.after=e.after.replace(/^\n?/,"\n")),e.before=e.before.replace(/(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*$)/,function(t){return e.startTag=t,""}),e.after=e.after.replace(/^(((\n|^)(\n[ \t]*)*>(.+\n)*.*)+(\n[ \t]*)*)/,function(t){return e.endTag=t,""});var a=function(t){var n=t?"> ":"";e.startTag&&(e.startTag=e.startTag.replace(/\n((>|\s)*)\n$/,function(e,t){return"\n"+t.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"})),e.endTag&&(e.endTag=e.endTag.replace(/^\n((>|\s)*)\n/,function(e,t){return"\n"+t.replace(/^[ ]{0,3}>?[ \t]*$/gm,n)+"\n"}))};/^(?![ ]{0,3}>)/m.test(e.selection)?(i.wrap(e,t.lineLength-2),e.selection=e.selection.replace(/^/gm,"> "),a(!0),e.addBlankLines()):(e.selection=e.selection.replace(/^[ ]{0,3}> ?/gm,""),i.unwrap(e),a(!1),!/^(\n|^)[ ]{0,3}>/.test(e.selection)&&e.startTag&&(e.startTag=e.startTag.replace(/\n{0,2}$/,"\n\n")),!/(\n|^)[ ]{0,3}>.*$/.test(e.selection)&&e.endTag&&(e.endTag=e.endTag.replace(/^\n{0,2}/,"\n\n"))),/\n/.test(e.selection)||(e.selection=e.selection.replace(/^(> *)/,function(t,n){return e.startTag+=n,""}))},i.doCode=function(e,t,n){var o=/\S[ ]*$/.test(e.before),i=/^[ ]*\S/.test(e.after);if(!i&&!o||/\n/.test(e.selection)){e.before=e.before.replace(/[ ]{4}$/,function(t){return e.selection=t+e.selection,""});var r=1,a=1;(/\n(\t|[ ]{4,}).*\n$/.test(e.before)||""===e.after)&&(r=0),/^\n(\t|[ ]{4,})/.test(e.after)&&(a=0),e.addBlankLines(r,a),e.selection?e.selection=/^[ ]{0,3}\S/m.test(e.selection)?e.selection.replace(/^/gm,"    "):e.selection.replace(/^[ ]{4}/gm,""):(e.startTag="    ",e.selection=n?"enter code here":"")}else e.trimWhitespace(),e.findTags(/`/,/`/),e.startTag||e.endTag?e.endTag&&!e.startTag?(e.before+=e.endTag,e.endTag=""):e.startTag=e.endTag="":(e.startTag=e.endTag="`",e.selection||(e.selection=n?"enter code here":""))},i.doList=function(e,n,o,r){var a=/(\n|^)(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*$/,s=/^\n*(([ ]{0,3}([*+-]|\d+[.])[ \t]+.*)(\n.+|\n{2,}([*+-].*|\d+[.])[ \t]+.*|\n{2,}[ \t]+\S.*)*)\n*/,d="-",c=1,u=function(){var e;return o?(e=" "+c+". ",c++):e=" "+d+" ",e},p=function(e){return void 0===o&&(o=/^\s*\d/.test(e)),e=e.replace(/^[ ]{0,3}([*+-]|\d+[.])\s/gm,function(){return u()})};if(e.findTags(/(\n|^)*[ ]{0,3}([*+-]|\d+[.])\s+/,null),!e.before||/\n$/.test(e.before)||/^\n/.test(e.startTag)||(e.before+=e.startTag,e.startTag=""),e.startTag){var f=/\d+[.]/.test(e.startTag);if(e.startTag="",e.selection=e.selection.replace(/\n[ ]{4}/g,"\n"),i.unwrap(e),e.addBlankLines(),f&&(e.after=e.after.replace(s,p)),o==f)return}var m=1;e.before=e.before.replace(a,function(e){return/^\s*([*+-])/.test(e)&&(d=l.$1),m=/[^\n]\n\n[^\n]/.test(e)?1:0,p(e)}),e.selection||(e.selection=r?"List item":" ");var h=u(),g=1;e.after=e.after.replace(s,function(e){return g=/[^\n]\n\n[^\n]/.test(e)?1:0,p(e)}),e.trimWhitespace(!0),e.addBlankLines(m,g,!0),e.startTag=h;var b=h.replace(/./g," ");i.wrap(e,t.lineLength-b.length),e.selection=e.selection.replace(/\n/g,"\n"+b)},i.doHeading=function(e){if(e.selection=e.selection.replace(/\s+/g," "),e.selection=e.selection.replace(/(^\s+|\s+$)/g,""),!e.selection)return e.startTag="## ",e.selection="Heading",void(e.endTag=" ##");var n=0;e.findTags(/#+[ ]*/,/[ ]*#+/),/#+/.test(e.startTag)&&(n=l.lastMatch.length),e.startTag=e.endTag="",e.findTags(null,/\s?(-+|=+)/),/=+/.test(e.endTag)&&(n=1),/-+/.test(e.endTag)&&(n=2),e.startTag=e.endTag="",e.addBlankLines(1,1);var o=0==n?2:n-1;if(o>0){var i=o>=2?"-":"=",r=e.selection.length;for(r>t.lineLength&&(r=t.lineLength),e.endTag="\n";r--;)e.endTag+=i}},i.doHorizontalRule=function(e){e.startTag="----------\n",e.selection="",e.addBlankLines(2,1,!0)}}}();